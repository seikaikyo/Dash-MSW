<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‡ªå‹•åŒ–ç³»çµ±æ¸¬è©¦</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #1a202c;
      color: #e2e8f0;
      padding: 2rem;
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      color: #a0aec0;
      margin-bottom: 2rem;
    }

    .control-panel {
      background: #2d3748;
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      border: 1px solid #4a5568;
    }

    .btn-group {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9375rem;
    }

    .btn-start {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
    }

    .btn-stop {
      background: linear-gradient(135deg, #f56565 0%, #e53e3e 100%);
      color: white;
    }

    .btn-clear {
      background: linear-gradient(135deg, #ed8936 0%, #dd6b20 100%);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .log-container {
      background: #2d3748;
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid #4a5568;
      margin-bottom: 1rem;
      min-height: 400px;
      max-height: 600px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.875rem;
    }

    .log-entry {
      margin-bottom: 0.5rem;
      padding: 0.5rem;
      border-radius: 4px;
      display: flex;
      align-items: flex-start;
      gap: 0.5rem;
    }

    .log-entry.info {
      background: rgba(66, 153, 225, 0.1);
      border-left: 3px solid #4299e1;
    }

    .log-entry.success {
      background: rgba(72, 187, 120, 0.1);
      border-left: 3px solid #48bb78;
    }

    .log-entry.error {
      background: rgba(245, 101, 101, 0.1);
      border-left: 3px solid #f56565;
    }

    .log-entry.warning {
      background: rgba(237, 137, 54, 0.1);
      border-left: 3px solid #ed8936;
    }

    .log-timestamp {
      color: #718096;
      font-size: 0.75rem;
      min-width: 80px;
    }

    .log-message {
      flex: 1;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .stat-card {
      background: #2d3748;
      border-radius: 12px;
      padding: 1.5rem;
      border: 1px solid #4a5568;
    }

    .stat-label {
      color: #a0aec0;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
    }

    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: #e2e8f0;
    }

    .stat-value.success {
      color: #48bb78;
    }

    .stat-value.error {
      color: #f56565;
    }

    .progress-bar {
      background: #4a5568;
      border-radius: 8px;
      height: 8px;
      overflow: hidden;
      margin-top: 0.5rem;
    }

    .progress-fill {
      background: linear-gradient(90deg, #48bb78, #38a169);
      height: 100%;
      transition: width 0.3s;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¤– MSW ç³»çµ±è‡ªå‹•åŒ–æ¸¬è©¦</h1>
    <p class="subtitle">å®Œæ•´æµç¨‹è‡ªå‹•åŒ–é©—è­‰</p>

    <div class="control-panel">
      <div class="btn-group">
        <button class="btn btn-start" id="btn-start">â–¶ï¸ é–‹å§‹æ¸¬è©¦</button>
        <button class="btn btn-stop" id="btn-stop" disabled>â¸ï¸ åœæ­¢æ¸¬è©¦</button>
        <button class="btn btn-clear" id="btn-clear">ğŸ—‘ï¸ æ¸…é™¤æ—¥èªŒ</button>
      </div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-label">æ¸¬è©¦é€²åº¦</div>
        <div class="stat-value" id="stat-progress">0/6</div>
        <div class="progress-bar">
          <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">æˆåŠŸ</div>
        <div class="stat-value success" id="stat-success">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å¤±æ•—</div>
        <div class="stat-value error" id="stat-failed">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">å»ºç«‹å·¥å–®æ•¸</div>
        <div class="stat-value" id="stat-workorders">0</div>
      </div>
    </div>

    <div class="log-container" id="log-container"></div>
  </div>

  <script type="module">
    import { FormInstanceModel } from './src/utils/dataModel.js';
    import { WorkOrderNumberGenerator } from './src/utils/workOrderNumberGenerator.js';

    let testRunning = false;
    let successCount = 0;
    let failedCount = 0;
    let currentTest = 0;
    const totalTests = 6;

    function log(message, type = 'info') {
      const logContainer = document.getElementById('log-container');
      const timestamp = new Date().toLocaleTimeString('zh-TW');

      const logEntry = document.createElement('div');
      logEntry.className = `log-entry ${type}`;
      logEntry.innerHTML = `
        <span class="log-timestamp">${timestamp}</span>
        <span class="log-message">${message}</span>
      `;

      logContainer.appendChild(logEntry);
      logContainer.scrollTop = logContainer.scrollHeight;
    }

    function updateStats() {
      document.getElementById('stat-progress').textContent = `${currentTest}/${totalTests}`;
      document.getElementById('stat-success').textContent = successCount;
      document.getElementById('stat-failed').textContent = failedCount;

      const progress = (currentTest / totalTests) * 100;
      document.getElementById('progress-fill').style.width = `${progress}%`;
    }

    function updateWorkOrderCount() {
      const workOrders = FormInstanceModel.getAll();
      const mswOrders = workOrders.filter(wo =>
        wo.data && wo.data.workOrderNo && wo.data.workOrderNo.startsWith('MSW-')
      );
      document.getElementById('stat-workorders').textContent = mswOrders.length;
    }

    async function test1_WorkOrderGeneration() {
      log('ğŸ“‹ æ¸¬è©¦ 1ï¼šå·¥å–®è™Ÿç¢¼ç”¢ç”Ÿå™¨', 'info');

      try {
        const before = FormInstanceModel.getAll().length;
        log(`æ¸¬è©¦å‰å·¥å–®æ•¸ï¼š${before}`);

        // ç”¢ç”Ÿ3ç­†å·¥å–®
        for (let i = 0; i < 3; i++) {
          const workOrderNo = WorkOrderNumberGenerator.generate();
          log(`ç”¢ç”Ÿå·¥å–®è™Ÿï¼š${workOrderNo}`, 'success');

          const instance = new FormInstanceModel({
            applicationNo: workOrderNo,
            formName: 'æŸ³ç‡Ÿå†ç”Ÿæ¿¾ç¶²å·¥å–®',
            applicant: 'æ¸¬è©¦ç³»çµ±',
            department: 'ç”Ÿç®¡éƒ¨',
            data: {
              workOrderNo: workOrderNo,
              batchNo: `BATCH-${workOrderNo.replace('MSW-', '')}`,
              sourceFactory: 'æŸ³ç‡Ÿå» ',
              filterType: 'æ´»æ€§ç¢³æ¿¾ç¶²',
              quantity: 50,
              regenerationCycle: 'R0 (é¦–æ¬¡å†ç”Ÿ)'
            },
            status: 'pending'
          });

          instance.save();
        }

        const after = FormInstanceModel.getAll().length;
        log(`æ¸¬è©¦å¾Œå·¥å–®æ•¸ï¼š${after}`);
        log(`æˆåŠŸå»ºç«‹ ${after - before} ç­†å·¥å–®`, 'success');

        updateWorkOrderCount();
        successCount++;
        return true;
      } catch (error) {
        log(`âŒ æ¸¬è©¦å¤±æ•—ï¼š${error.message}`, 'error');
        failedCount++;
        return false;
      }
    }

    async function test2_WorkOrderUniqueness() {
      log('ğŸ”¢ æ¸¬è©¦ 2ï¼šå·¥å–®è™Ÿå”¯ä¸€æ€§', 'info');

      try {
        const workOrders = FormInstanceModel.getAll();
        const mswOrders = workOrders.filter(wo =>
          wo.data && wo.data.workOrderNo && wo.data.workOrderNo.startsWith('MSW-')
        );

        const numbers = mswOrders.map(wo => wo.data.workOrderNo);
        const unique = [...new Set(numbers)];

        log(`ç¸½å·¥å–®æ•¸ï¼š${numbers.length}`);
        log(`å”¯ä¸€å·¥å–®è™Ÿæ•¸ï¼š${unique.length}`);

        if (numbers.length === unique.length) {
          log('âœ… æ‰€æœ‰å·¥å–®è™Ÿç¢¼éƒ½æ˜¯å”¯ä¸€çš„', 'success');
          successCount++;
          return true;
        } else {
          const duplicates = numbers.filter((no, index) =>
            numbers.indexOf(no) !== index
          );
          log(`âŒ ç™¼ç¾é‡è¤‡å·¥å–®è™Ÿï¼š${[...new Set(duplicates)].join(', ')}`, 'error');
          failedCount++;
          return false;
        }
      } catch (error) {
        log(`âŒ æ¸¬è©¦å¤±æ•—ï¼š${error.message}`, 'error');
        failedCount++;
        return false;
      }
    }

    async function test3_WorkOrderFormat() {
      log('ğŸ“ æ¸¬è©¦ 3ï¼šå·¥å–®è™Ÿæ ¼å¼é©—è­‰', 'info');

      try {
        const workOrders = FormInstanceModel.getAll();
        const mswOrders = workOrders.filter(wo =>
          wo.data && wo.data.workOrderNo && wo.data.workOrderNo.startsWith('MSW-')
        );

        const pattern = /^MSW-\d{4}-\d{4}$/;
        let allValid = true;

        mswOrders.forEach(wo => {
          const no = wo.data.workOrderNo;
          if (!pattern.test(no)) {
            log(`âŒ æ ¼å¼éŒ¯èª¤ï¼š${no}`, 'error');
            allValid = false;
          }
        });

        if (allValid) {
          log(`âœ… æ‰€æœ‰ ${mswOrders.length} å€‹å·¥å–®è™Ÿæ ¼å¼æ­£ç¢º (MSW-YYYY-NNNN)`, 'success');
          successCount++;
          return true;
        } else {
          failedCount++;
          return false;
        }
      } catch (error) {
        log(`âŒ æ¸¬è©¦å¤±æ•—ï¼š${error.message}`, 'error');
        failedCount++;
        return false;
      }
    }

    async function test4_BatchCreation() {
      log('ğŸ­ æ¸¬è©¦ 4ï¼šæ‰¹æ¬¡å»ºç«‹åŠŸèƒ½', 'info');

      try {
        const beforeCount = FormInstanceModel.getAll().filter(wo =>
          wo.data && wo.data.workOrderNo && wo.data.workOrderNo.startsWith('MSW-')
        ).length;

        log(`æ‰¹æ¬¡å»ºç«‹å‰ï¼š${beforeCount} ç­†å·¥å–®`);

        // æ¨¡æ“¬æ‰¹æ¬¡å»ºç«‹ 5 ç­†
        const batchCount = 5;
        const createdOrders = [];

        for (let i = 0; i < batchCount; i++) {
          const workOrderNo = WorkOrderNumberGenerator.generate();
          const batchNo = `BATCH-${workOrderNo.replace('MSW-', '')}`;

          const instance = new FormInstanceModel({
            applicationNo: workOrderNo,
            formName: 'æŸ³ç‡Ÿå†ç”Ÿæ¿¾ç¶²å·¥å–®',
            applicant: 'æ‰¹æ¬¡æ¸¬è©¦',
            department: 'ç”Ÿç®¡éƒ¨',
            data: {
              workOrderNo: workOrderNo,
              batchNo: batchNo,
              sourceFactory: 'æŸ³ç‡Ÿå» ',
              filterType: 'åŒ–å­¸æ¿¾ç¶²',
              quantity: 100,
              regenerationCycle: 'R1 (ç¬¬äºŒæ¬¡)'
            },
            status: 'pending'
          });

          instance.save();
          createdOrders.push(workOrderNo);
        }

        const afterCount = FormInstanceModel.getAll().filter(wo =>
          wo.data && wo.data.workOrderNo && wo.data.workOrderNo.startsWith('MSW-')
        ).length;

        log(`æ‰¹æ¬¡å»ºç«‹å¾Œï¼š${afterCount} ç­†å·¥å–®`);
        log(`æˆåŠŸå»ºç«‹ï¼š${createdOrders.join(', ')}`, 'success');

        if (afterCount - beforeCount === batchCount) {
          log(`âœ… æ‰¹æ¬¡å»ºç«‹æˆåŠŸï¼Œæ–°å¢ ${batchCount} ç­†å·¥å–®`, 'success');
          updateWorkOrderCount();
          successCount++;
          return true;
        } else {
          log(`âŒ æ‰¹æ¬¡å»ºç«‹æ•¸é‡ä¸ç¬¦ï¼Œé æœŸ ${batchCount}ï¼Œå¯¦éš› ${afterCount - beforeCount}`, 'error');
          failedCount++;
          return false;
        }
      } catch (error) {
        log(`âŒ æ¸¬è©¦å¤±æ•—ï¼š${error.message}`, 'error');
        failedCount++;
        return false;
      }
    }

    async function test5_WorkOrderData() {
      log('ğŸ“Š æ¸¬è©¦ 5ï¼šå·¥å–®è³‡æ–™å®Œæ•´æ€§', 'info');

      try {
        const workOrders = FormInstanceModel.getAll();
        const mswOrders = workOrders.filter(wo =>
          wo.data && wo.data.workOrderNo && wo.data.workOrderNo.startsWith('MSW-')
        );

        let allValid = true;
        const requiredFields = ['workOrderNo', 'batchNo', 'sourceFactory', 'filterType', 'quantity', 'regenerationCycle'];

        mswOrders.forEach(wo => {
          const missing = requiredFields.filter(field => !wo.data[field]);
          if (missing.length > 0) {
            log(`âŒ å·¥å–® ${wo.data.workOrderNo} ç¼ºå°‘æ¬„ä½ï¼š${missing.join(', ')}`, 'warning');
            allValid = false;
          }
        });

        if (allValid) {
          log(`âœ… æ‰€æœ‰ ${mswOrders.length} å€‹å·¥å–®è³‡æ–™å®Œæ•´`, 'success');
          successCount++;
          return true;
        } else {
          failedCount++;
          return false;
        }
      } catch (error) {
        log(`âŒ æ¸¬è©¦å¤±æ•—ï¼š${error.message}`, 'error');
        failedCount++;
        return false;
      }
    }

    async function test6_YearSequence() {
      log('ğŸ“… æ¸¬è©¦ 6ï¼šå¹´åº¦åºè™Ÿæ©Ÿåˆ¶', 'info');

      try {
        const workOrders = FormInstanceModel.getAll();
        const mswOrders = workOrders.filter(wo =>
          wo.data && wo.data.workOrderNo && wo.data.workOrderNo.startsWith('MSW-')
        );

        const currentYear = new Date().getFullYear();
        const thisYearOrders = mswOrders.filter(wo =>
          wo.data.workOrderNo.startsWith(`MSW-${currentYear}-`)
        );

        log(`${currentYear} å¹´å·¥å–®æ•¸ï¼š${thisYearOrders.length}`);

        // æª¢æŸ¥åºè™Ÿæ˜¯å¦é€£çºŒ
        const sequences = thisYearOrders
          .map(wo => {
            const match = wo.data.workOrderNo.match(/MSW-\d{4}-(\d{4})$/);
            return match ? parseInt(match[1], 10) : 0;
          })
          .sort((a, b) => a - b);

        log(`åºè™Ÿç¯„åœï¼š${sequences[0]} ~ ${sequences[sequences.length - 1]}`);

        // æª¢æŸ¥æ˜¯å¦æœ‰åºè™Ÿ
        if (sequences.length > 0 && sequences[0] >= 1) {
          log(`âœ… å¹´åº¦åºè™Ÿæ©Ÿåˆ¶æ­£å¸¸é‹ä½œ`, 'success');
          successCount++;
          return true;
        } else {
          log(`âŒ åºè™Ÿç•°å¸¸`, 'error');
          failedCount++;
          return false;
        }
      } catch (error) {
        log(`âŒ æ¸¬è©¦å¤±æ•—ï¼š${error.message}`, 'error');
        failedCount++;
        return false;
      }
    }

    async function runAllTests() {
      if (testRunning) return;

      testRunning = true;
      successCount = 0;
      failedCount = 0;
      currentTest = 0;

      document.getElementById('btn-start').disabled = true;
      document.getElementById('btn-stop').disabled = false;

      log('ğŸš€ é–‹å§‹åŸ·è¡Œè‡ªå‹•åŒ–æ¸¬è©¦...', 'info');
      log('â”'.repeat(60), 'info');

      const tests = [
        test1_WorkOrderGeneration,
        test2_WorkOrderUniqueness,
        test3_WorkOrderFormat,
        test4_BatchCreation,
        test5_WorkOrderData,
        test6_YearSequence
      ];

      for (let i = 0; i < tests.length; i++) {
        if (!testRunning) break;

        currentTest = i + 1;
        updateStats();

        await tests[i]();
        log('â”€'.repeat(60), 'info');

        // ç­‰å¾…ä¸€ä¸‹å†åŸ·è¡Œä¸‹ä¸€å€‹æ¸¬è©¦
        await new Promise(resolve => setTimeout(resolve, 500));
      }

      log('â”'.repeat(60), 'info');
      log(`âœ… æ¸¬è©¦å®Œæˆï¼æˆåŠŸï¼š${successCount}ï¼Œå¤±æ•—ï¼š${failedCount}`, successCount === totalTests ? 'success' : 'warning');

      testRunning = false;
      document.getElementById('btn-start').disabled = false;
      document.getElementById('btn-stop').disabled = true;
    }

    function stopTests() {
      testRunning = false;
      log('â¸ï¸ æ¸¬è©¦å·²åœæ­¢', 'warning');
      document.getElementById('btn-start').disabled = false;
      document.getElementById('btn-stop').disabled = true;
    }

    function clearLogs() {
      document.getElementById('log-container').innerHTML = '';
      log('ğŸ—‘ï¸ æ—¥èªŒå·²æ¸…é™¤', 'info');
    }

    // ç¶å®šæŒ‰éˆ•äº‹ä»¶
    document.getElementById('btn-start').addEventListener('click', runAllTests);
    document.getElementById('btn-stop').addEventListener('click', stopTests);
    document.getElementById('btn-clear').addEventListener('click', clearLogs);

    // åˆå§‹åŒ–
    log('âœ… æ¸¬è©¦ç³»çµ±å·²å°±ç·’', 'success');
    updateWorkOrderCount();
  </script>
</body>
</html>

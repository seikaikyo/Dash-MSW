# 條件分支功能測試指南

**測試日期**：2025-10-09
**版本**：v0.4.0 (Phase 5, Stage 1)

---

## 測試前準備

### 1. 建立測試資料

#### 部門與人員（如果尚未建立）
1. 進入「人員管理」
2. 新增部門：
   - IT部
   - 人力資源部
   - 財務部
3. 新增人員：
   - 張三（IT部，主管）
   - 李四（IT部，主管）
   - 王五（人力資源部，主管）
   - 趙六（財務部，主管）

#### 建立測試表單

**表單名稱**：請假申請單（含條件）

**表單欄位**：
1. 列 1：
   - 文字輸入 - 申請人（必填）
2. 列 2：
   - 日期 - 開始日期（必填）
   - 日期 - 結束日期（必填）
3. 列 3：
   - 數字 - 請假天數 (ID: days)（必填）
4. 列 4：
   - 下拉選單 - 請假類型 (ID: type)
     選項：病假、事假、特休
5. 列 5：
   - 多行文字 - 請假事由

**注意**：欄位 ID 必須設定為 `days` 和 `type`，這是條件判斷的關鍵！

---

## 測試案例 1：簡單數值條件（請假天數判斷）

### 1.1 建立條件分支流程

**流程名稱**：請假天數分支流程

**流程設計**：
```
開始
  ↓
條件判斷
  ├─ days > 3 → 單簽(總經理-趙六) → 結束
  ├─ days <= 3 → 單簽(部門主管-李四) → 結束
  └─ 預設 → 單簽(李四) → 結束
```

**步驟**：
1. 進入「流程管理」→「建立流程」
2. 流程名稱：請假天數分支流程
3. 拖曳節點：
   - 開始（已存在）
   - 條件分支
   - 單簽 x 2
   - 結束 x 2
4. 連接節點（注意輸出點）：
   - 開始 → 條件判斷
   - 條件判斷 [out-right] → 單簽(趙六)
   - 條件判斷 [out-bottom] → 單簽(李四)
   - 單簽(趙六) → 結束1
   - 單簽(李四) → 結束2

### 1.2 設定條件節點

1. 選中「條件判斷」節點
2. 在右側屬性面板，點擊「+ 新增規則」

**規則 1**：請假天數大於3天
- 規則名稱：請假天數 > 3
- 輸出點：右側 (out-right)
- 條件邏輯：全部符合 (AND)
- 條件列表：
  - 欄位：days
  - 運算子：大於 (>)
  - 比較值：3
- 點擊「儲存」

**規則 2**：請假天數小於等於3天
- 規則名稱：請假天數 ≤ 3
- 輸出點：下方 (out-bottom)
- 條件邏輯：全部符合 (AND)
- 條件列表：
  - 欄位：days
  - 運算子：小於等於 (<=)
  - 比較值：3
- 點擊「儲存」

**預設分支**：
- 選擇：下方 (out-bottom)

3. 儲存流程

### 1.3 測試：請假 2 天（應走部門主管分支）

1. 進入「發起申請」
2. 選擇表單：請假申請單（含條件）
3. 選擇流程：請假天數分支流程
4. 填寫資料：
   - 申請人：測試員工A
   - 開始日期：2025/10/10
   - 結束日期：2025/10/11
   - **請假天數：2**
   - 請假類型：病假
   - 請假事由：身體不適
5. 提交申請
6. 記下申請編號

**預期結果**：
- ✓ 申請成功提交
- ✓ 進入「簽核中心」→「全部申請」
- ✓ 查看詳情，目前節點應為：單簽(李四)
- ✓ 待簽核人員：李四
- ✓ 簽核歷史應顯示：
  - 發起申請
  - 條件符合：請假天數 ≤ 3，走 out-bottom 分支

### 1.4 測試：請假 5 天（應走總經理分支）

1. 重複步驟 1.3，但修改：
   - **請假天數：5**

**預期結果**：
- ✓ 目前節點應為：單簽(趙六)
- ✓ 待簽核人員：趙六
- ✓ 簽核歷史應顯示：
  - 發起申請
  - 條件符合：請假天數 > 3，走 out-right 分支

### 1.5 完成簽核測試

1. 簽核人登入（李四或趙六）
2. 核准申請
3. 確認流程完成，狀態變為「已通過」

---

## 測試案例 2：複合條件（部門 + 金額）

### 2.1 建立新表單

**表單名稱**：報支申請單

**表單欄位**：
1. 文字輸入 - 申請人
2. 文字輸入 - 部門 (ID: department)
3. 數字 - 報支金額 (ID: amount)
4. 多行文字 - 報支事由

### 2.2 建立複合條件流程

**流程名稱**：報支複合條件流程

**流程設計**：
```
開始
  ↓
條件判斷
  ├─ (department == "財務部" AND amount > 10000) → 並簽(趙六+王五) → 結束
  ├─ amount > 10000 → 單簽(趙六) → 結束
  └─ 預設 → 單簽(李四) → 結束
```

**條件規則**：

**規則 1**：財務部高額報支
- 規則名稱：財務部高額報支
- 輸出點：右側 (out-right)
- 條件邏輯：全部符合 (AND)
- 條件列表：
  1. 欄位：department，運算子：等於 (==)，比較值：財務部
  2. 欄位：amount，運算子：大於 (>)，比較值：10000

**規則 2**：一般高額報支
- 規則名稱：一般高額報支
- 輸出點：下方 (out-bottom)
- 條件邏輯：全部符合 (AND)
- 條件列表：
  1. 欄位：amount，運算子：大於 (>)，比較值：10000

**預設分支**：左側 (out-left)

### 2.3 測試案例

#### 測試 A：財務部 + 金額 15000（應走並簽）
- department: 財務部
- amount: 15000
- **預期**：並簽(趙六+王五)

#### 測試 B：IT部 + 金額 15000（應走一般高額）
- department: IT部
- amount: 15000
- **預期**：單簽(趙六)

#### 測試 C：財務部 + 金額 5000（應走預設）
- department: 財務部
- amount: 5000
- **預期**：單簽(李四)

#### 測試 D：IT部 + 金額 5000（應走預設）
- department: IT部
- amount: 5000
- **預期**：單簽(李四)

---

## 測試案例 3：字串條件

### 3.1 建立字串條件流程

**條件規則範例**：

**contains（包含）**：
- 欄位：reason（事由）
- 運算子：包含 (contains)
- 比較值：緊急

**startsWith（開頭是）**：
- 欄位：type（類型）
- 運算子：開頭是 (startsWith)
- 比較值：病

**isEmpty（為空）**：
- 欄位：comment（備註）
- 運算子：為空 (isEmpty)
- 比較值：（不需要）

### 3.2 測試各種字串運算子

1. 測試 contains：輸入包含關鍵字的文字
2. 測試 startsWith：輸入特定開頭的文字
3. 測試 endsWith：輸入特定結尾的文字
4. 測試 isEmpty：留空欄位
5. 測試 isNotEmpty：填寫欄位

---

## 測試案例 4：OR 邏輯

### 4.1 建立 OR 邏輯規則

**規則範例**：緊急情況或高金額
- 條件邏輯：任一符合 (OR)
- 條件列表：
  1. 欄位：urgent，運算子：等於 (==)，比較值：true
  2. 欄位：amount，運算子：大於 (>)，比較值：50000

**測試**：
- 測試 A：urgent=true, amount=1000 → 應符合
- 測試 B：urgent=false, amount=60000 → 應符合
- 測試 C：urgent=false, amount=1000 → 不符合

---

## 測試案例 5：多層條件

### 5.1 建立多層條件流程

**流程設計**：
```
開始
  ↓
條件判斷 1（金額判斷）
  ├─ amount > 50000 → 條件判斷 2（部門判斷）
  │                      ├─ department == "財務部" → 並簽(財+總)
  │                      └─ 預設 → 單簽(總經理)
  └─ 預設 → 單簽(部門主管)
```

**測試流程自動推進**：
- 條件節點應自動評估，不需人工簽核
- 申請應直接到達簽核節點

---

## 測試檢查清單

### UI 測試
- [ ] 條件節點的屬性面板正確顯示
- [ ] 「+ 新增規則」按鈕正常運作
- [ ] 規則編輯器 Modal 正常開啟/關閉
- [ ] 條件列表正確顯示已設定的規則
- [ ] 規則可以編輯、刪除
- [ ] 條件編輯器支援所有運算子
- [ ] 運算子選擇正確切換（isEmpty 時禁用值輸入）
- [ ] 預設分支設定正常

### 功能測試
- [ ] 簡單數值條件正確判斷 (>, <, >=, <=, ==, !=)
- [ ] 字串條件正確判斷 (contains, startsWith, endsWith)
- [ ] 空值條件正確判斷 (isEmpty, isNotEmpty)
- [ ] AND 邏輯正確運作（所有條件都符合）
- [ ] OR 邏輯正確運作（任一條件符合）
- [ ] 複合條件正確判斷
- [ ] 規則優先順序正確（符合第一個規則即走該分支）
- [ ] 預設分支正確運作（無條件符合時）
- [ ] 條件節點自動評估（不需人工簽核）
- [ ] 多層條件正確推進

### 資料測試
- [ ] 條件規則正確儲存到 WorkflowModel
- [ ] 流程載入後條件規則正確還原
- [ ] 簽核歷史正確記錄條件判斷結果
- [ ] 條件判斷記錄包含規則名稱和分支資訊

### 錯誤處理
- [ ] 欄位不存在時條件判斷為 false
- [ ] 欄位值為 null/undefined 時正確處理
- [ ] 無有效輸出連接時顯示錯誤
- [ ] 無規則符合且無預設分支時顯示錯誤

---

## 預期問題與解決方案

### 問題 1：欄位 ID 找不到
**原因**：表單欄位未設定 ID 或 ID 不正確
**解決**：回到表單建置器，編輯欄位屬性，設定正確的 ID

### 問題 2：條件永遠不符合
**原因**：資料類型不匹配（例如數字與字串比較）
**解決**：檢查表單欄位類型，確保輸入正確的資料類型

### 問題 3：條件節點卡住不動
**原因**：沒有連接輸出分支
**解決**：確保每個規則的輸出點都有連接到下一節點

### 問題 4：簽核歷史沒有條件記錄
**原因**：條件判斷未執行或記錄失敗
**解決**：檢查 console 是否有錯誤訊息

---

## 測試完成確認

- [ ] 所有測試案例都通過
- [ ] UI 顯示正常
- [ ] 功能運作正確
- [ ] 資料儲存正確
- [ ] 錯誤處理正常
- [ ] 準備提交到 Git

---

## 測試結果記錄

**測試日期**：_____________

**測試人員**：_____________

**測試結果**：

| 測試案例 | 結果 | 備註 |
|----------|------|------|
| 簡單數值條件 | ⬜ 通過 / ⬜ 失敗 | |
| 複合條件 | ⬜ 通過 / ⬜ 失敗 | |
| 字串條件 | ⬜ 通過 / ⬜ 失敗 | |
| OR 邏輯 | ⬜ 通過 / ⬜ 失敗 | |
| 多層條件 | ⬜ 通過 / ⬜ 失敗 | |

**發現問題**：

1.

**修復方案**：

1.

**總結**：

⬜ 全部測試通過，可以交付
⬜ 有問題需要修復

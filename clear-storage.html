<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>æ¸…ç† LocalStorage</title>
  <style>
    body { font-family: monospace; padding: 20px; max-width: 600px; margin: 0 auto; }
    button { background: #ef4444; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
    button:hover { background: #dc2626; }
    button.info { background: #3b82f6; }
    button.info:hover { background: #2563eb; }
    pre { background: #1e293b; color: #e2e8f0; padding: 20px; border-radius: 8px; overflow-x: auto; }
  </style>
</head>
<body>
  <h1>ğŸ§¹ LocalStorage æ¸…ç†å·¥å…·</h1>
  <button class="info" onclick="checkStorage()">æª¢æŸ¥ä½¿ç”¨æƒ…æ³</button>
  <button onclick="clearStorage()">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
  <pre id="output">é»æ“ŠæŒ‰éˆ•æª¢æŸ¥ LocalStorage ä½¿ç”¨æƒ…æ³...</pre>

  <script type="module">
    import { storage } from './src/utils/storage.js';

    window.checkStorage = function() {
      const output = document.getElementById('output');
      const info = storage.getStorageInfo();
      
      if (!info) {
        output.textContent = 'ç„¡æ³•å–å¾— LocalStorage è³‡è¨Š';
        return;
      }

      output.textContent = `LocalStorage ä½¿ç”¨æƒ…æ³\n\n`;
      output.textContent += `ç¸½ä½¿ç”¨é‡: ${info.totalMB}MB / ${info.limitMB}MB (${info.usagePercent}%)\n`;
      output.textContent += `é …ç›®æ•¸é‡: ${info.itemCount}\n\n`;
      output.textContent += `å„é …ç›®å¤§å°:\n`;

      // æŒ‰å¤§å°æ’åº
      const sorted = Object.entries(info.itemSizes)
        .map(([key, size]) => ({ key, size }))
        .sort((a, b) => b.size - a.size);

      sorted.forEach(({ key, size }) => {
        const kb = (size / 1024).toFixed(2);
        const name = key.replace('bpm_', '');
        output.textContent += `  ${name}: ${kb}KB\n`;
      });

      if (parseFloat(info.usagePercent) > 80) {
        output.textContent += `\nâš ï¸  è­¦å‘Šï¼šLocalStorage ä½¿ç”¨ç‡è¶…é 80%ï¼\n`;
        output.textContent += `å»ºè­°æ¸…é™¤è³‡æ–™ä»¥é¿å…å„²å­˜å¤±æ•—ã€‚\n`;
      }
    };

    window.clearStorage = function() {
      if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰ LocalStorage è³‡æ–™å—ï¼Ÿ\n\né€™å°‡åˆªé™¤æ‰€æœ‰é…æ–¹ã€ä½¿ç”¨è€…ã€SPC æ•¸æ“šç­‰ã€‚\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
        return;
      }

      const output = document.getElementById('output');
      output.textContent = 'æ¸…ç†ä¸­...\n\n';

      try {
        const beforeInfo = storage.getStorageInfo();
        output.textContent += `æ¸…ç†å‰: ${beforeInfo.totalMB}MB\n`;

        storage.clear();

        const afterInfo = storage.getStorageInfo();
        output.textContent += `æ¸…ç†å¾Œ: ${afterInfo.totalMB}MB\n\n`;
        output.textContent += 'âœ… æ‰€æœ‰è³‡æ–™å·²æ¸…é™¤ï¼\n\n';
        output.textContent += 'è«‹é‡æ–°æ•´ç†é é¢ã€‚';

        setTimeout(() => {
          location.reload();
        }, 2000);
      } catch (error) {
        output.textContent += '\nâŒ æ¸…ç†å¤±æ•—: ' + error.message;
      }
    };

    // è‡ªå‹•æª¢æŸ¥
    setTimeout(() => {
      window.checkStorage();
    }, 100);
  </script>
</body>
</html>
